import numpy as np
import pytest

from duly.density_estimation import DensityEstimation


def test_clustering_basics():
    """Test the density estimation operations work correctly"""
    X = np.random.uniform(size=(50, 2))

    de = DensityEstimation(coordinates=X)

    de.compute_distances(maxk=25)

    de.compute_id_2NN()
    assert pytest.approx(2.04, de.id_selected)

    de.compute_density_kNN(10)

    # Check we get the expected answer
    assert np.array_equal(
        de.Rho,
        np.array(
            [0.1844888858553566, -0.13305086762744134, 0.0902010248228522, -0.4685648655317629, -0.8754575058822796,
             -0.35359466701001674, -0.6787714622756069, -1.0249459359197366, -1.1146791344356708, -0.5752767348305059,
             -1.0448877004804982, 0.20454016078937842, -0.3512910393243662, -0.9480108058391639, 0.30655676409560373,
             -0.18020577833950258, 0.39434665621194354, -0.824581679812185, -0.2976000014129965, -0.8805024461341677,
             -0.04650718685853361, -0.26931931924530117, -0.12300058147390702, -0.3457636787378635, 0.07246687629433479,
             0.048740531028267586, -0.9502604795289935, -0.1384340995511244, 0.12163831253783508, 0.3181515837236044,
             -0.5854901837153368, 0.337058393945624, -0.1881381827015738, -0.3462152027703662, -0.4099894544179894,
             -0.8652065931384083, -1.0901503844561904, -0.2046467971066348, -0.04432572638732735, -0.09056605483674174,
             0.02239404245247867, -0.7763102621161093, -0.0954074851619855, 0.0571533655420331, -0.7246430817092224,
             0.027371426780234298, -0.6416242563707848, 0.15507084128946813, -0.0412478199375399, -0.7393307503891751])
    )
